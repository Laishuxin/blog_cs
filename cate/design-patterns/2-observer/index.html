<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>设计模式 - 观察者模式 | Ru Shui</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/blog_cs/assets/img/logo.png">
    <link rel="manifest" href="/blog_cs/manifest.webmanifest" crossorigin="use-credentials">
    <meta name="description" content="To Build Amazing Things !">
    <meta property="og:url" content="/blog_cs/cate/design-patterns/2-observer.html">
    <meta property="og:site_name" content="Ru Shui">
    <meta property="og:title" content="设计模式 - 观察者模式">
    <meta property="og:type" content="article">
    <meta property="og:locale" content="en-US">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image:alt" content="Ru Shui">
    <meta property="article:author" content="ru shui">
    <meta property="article:tag" content="typescript">
    <meta property="article:published_time" content="2021-05-14T00:00:00.000Z">
    <meta name="keywords" content="backend computer science">
    <meta name="author" content="ru shui">
    <meta name="theme-color" content="#46bd87">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <link rel="preload" href="/blog_cs/assets/css/0.styles.c0f28275.css" as="style"><link rel="preload" href="/blog_cs/assets/js/app.16bd55a2.js" as="script"><link rel="preload" href="/blog_cs/assets/js/layout-Layout.05aaa927.js" as="script"><link rel="preload" href="/blog_cs/assets/js/vendors~layout-Blog~layout-Layout~layout-NotFound.4b319992.js" as="script"><link rel="preload" href="/blog_cs/assets/js/vendors~layout-Blog~layout-Layout~layout-NotFound~layout-Slide.4e62ce68.js" as="script"><link rel="preload" href="/blog_cs/assets/js/vendors~layout-Blog~layout-Layout.6d1cfc91.js" as="script"><link rel="preload" href="/blog_cs/assets/js/page-设计模式-观察者模式.62b37d84.js" as="script"><link rel="prefetch" href="/blog_cs/assets/js/44.d134d706.js"><link rel="prefetch" href="/blog_cs/assets/js/45.eef8e3be.js"><link rel="prefetch" href="/blog_cs/assets/js/46.cfe5b283.js"><link rel="prefetch" href="/blog_cs/assets/js/47.46ba4682.js"><link rel="prefetch" href="/blog_cs/assets/js/48.2d7eb269.js"><link rel="prefetch" href="/blog_cs/assets/js/layout-Blog.286edd81.js"><link rel="prefetch" href="/blog_cs/assets/js/layout-NotFound.d696089a.js"><link rel="prefetch" href="/blog_cs/assets/js/layout-Slide.2ea672bd.js"><link rel="prefetch" href="/blog_cs/assets/js/page--38ab1f94.0ee91aa9.js"><link rel="prefetch" href="/blog_cs/assets/js/page--5e8d4d74.d527bf01.js"><link rel="prefetch" href="/blog_cs/assets/js/page--604125d4.98b6061f.js"><link rel="prefetch" href="/blog_cs/assets/js/page--aebf9a98.4de74a90.js"><link rel="prefetch" href="/blog_cs/assets/js/page--c12d42ec.320d7a0a.js"><link rel="prefetch" href="/blog_cs/assets/js/page-InformationStorage.4384310d.js"><link rel="prefetch" href="/blog_cs/assets/js/page-IntegerRepresentations.b0b42886.js"><link rel="prefetch" href="/blog_cs/assets/js/page-about.d3bf3112.js"><link rel="prefetch" href="/blog_cs/assets/js/page-csapp.fe293514.js"><link rel="prefetch" href="/blog_cs/assets/js/page-分类.c2ac9436.js"><link rel="prefetch" href="/blog_cs/assets/js/page-数据结构与算法-二分.2da042c8.js"><link rel="prefetch" href="/blog_cs/assets/js/page-数据结构与算法-前缀和和差分.5ec19ad9.js"><link rel="prefetch" href="/blog_cs/assets/js/page-数据结构与算法-排序.2e430056.js"><link rel="prefetch" href="/blog_cs/assets/js/page-数据结构与算法-高精度算法.8654db28.js"><link rel="prefetch" href="/blog_cs/assets/js/page-数据结构与算法.167704e2.js"><link rel="prefetch" href="/blog_cs/assets/js/page-计算机网络-http.ccef104d.js"><link rel="prefetch" href="/blog_cs/assets/js/page-计算机网络-传输层.940184bb.js"><link rel="prefetch" href="/blog_cs/assets/js/page-计算机网络-链路层.97d0e551.js"><link rel="prefetch" href="/blog_cs/assets/js/page-计算机网络.a73822f1.js"><link rel="prefetch" href="/blog_cs/assets/js/page-设计模式-单例模式.ae87fd95.js"><link rel="prefetch" href="/blog_cs/assets/js/page-设计模式-原型模式.e73be0f1.js"><link rel="prefetch" href="/blog_cs/assets/js/page-设计模式-工厂模式.f81efa2f.js"><link rel="prefetch" href="/blog_cs/assets/js/page-设计模式-建造者模式（生成器模式）.b000530b.js"><link rel="prefetch" href="/blog_cs/assets/js/page-设计模式-模板模式.b6b4708a.js"><link rel="prefetch" href="/blog_cs/assets/js/page-设计模式-策略模式.7bdc8213.js"><link rel="prefetch" href="/blog_cs/assets/js/page-设计模式-组合模式.3aa54ac1.js"><link rel="prefetch" href="/blog_cs/assets/js/page-设计模式-装饰者模式.7887cd58.js"><link rel="prefetch" href="/blog_cs/assets/js/page-设计模式-设计原则.bbb33c17.js"><link rel="prefetch" href="/blog_cs/assets/js/page-设计模式-迭代器模式.5a74e9b0.js"><link rel="prefetch" href="/blog_cs/assets/js/page-设计模式-适配器模式.970d96e8.js"><link rel="prefetch" href="/blog_cs/assets/js/page-设计模式.28e3cb91.js"><link rel="prefetch" href="/blog_cs/assets/js/page-首页.a1e93793.js"><link rel="prefetch" href="/blog_cs/assets/js/vendors~photo-swipe.c256e8d9.js"><link rel="prefetch" href="/blog_cs/assets/js/vendors~reveal.58127042.js">
    <link rel="stylesheet" href="/blog_cs/assets/css/0.styles.c0f28275.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container has-navbar has-sidebar has-anchor"><header class="navbar"><button class="sidebar-button"><span class="icon"></span></button> <a href="/blog_cs/" class="home-link router-link-active"><img src="/blog_cs/assets/img/logo.png" alt="Ru Shui" class="logo"> <!----> <span class="site-name can-hide">Ru Shui</span></a> <div class="links"><button class="color-button"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="skin-icon"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4
        38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32
        51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0
        102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2
        6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4
        0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2
        9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224
        419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4
        470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0
        22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6
        12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128
        505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2
        16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8
        86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4
        80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6
        6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg> <div class="color-picker-menu" style="display:none;"><div class="theme-options"><ul class="themecolor-select"><label for="themecolor-select">Theme Color:</label> <li><a href="#" class="default-theme"></a></li> </ul> <div class="darkmode-toggle"><label for="darkmode-toggle" class="desc">Theme Mode:</label> <div class="darkmode-switch"><div class="switch"><input id="switch" type="checkbox" checked="checked" class="switch-input"> <label for="switch" class="label"><span class="label-content"></span></label></div></div> <!----></div></div></div></button> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog_cs/" class="nav-link router-link-active"><!---->
  首页
</a></div><div class="nav-item"><a href="/blog_cs/category/" class="nav-link"><!---->
  分类
</a></div><div class="nav-item"><a href="/blog_cs/tag/" class="nav-link"><!---->
  标签
</a></div><div class="nav-item"><a href="/blog_cs/timeline/" class="nav-link"><!---->
  归档
</a></div><div class="nav-item"><a href="/blog_cs/about/" class="nav-link"><!---->
  关于
</a></div></nav> <!----> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><div vocab="https://schema.org/" typeof="Person" class="blogger-info"><div data-balloon-pos="" class="blogger"><img property="image" alt="Blogger Avatar" src="/blog_cs/assets/img/logo.png" class="avatar"> <div property="name" class="name">ru shui</div> <!----></div> <div class="num-wrapper"><div><div class="num">26</div> <div>Articles</div></div> <div><div class="num">7</div> <div>Category</div></div> <div><div class="num">18</div> <div>Tags</div></div> <div><div class="num">26</div> <div>Timeline</div></div></div> <!----></div> <hr>  <nav class="sidebar-nav-links"><div class="nav-item"><a href="/blog_cs/" class="nav-link router-link-active"><!---->
  首页
</a></div><div class="nav-item"><a href="/blog_cs/category/" class="nav-link"><!---->
  分类
</a></div><div class="nav-item"><a href="/blog_cs/tag/" class="nav-link"><!---->
  标签
</a></div><div class="nav-item"><a href="/blog_cs/timeline/" class="nav-link"><!---->
  归档
</a></div><div class="nav-item"><a href="/blog_cs/about/" class="nav-link"><!---->
  关于
</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/blog_cs/cate/design-patterns/0-principles/" class="sidebar-link">设计模式 - 设计原则</a></li><li><a href="/blog_cs/cate/design-patterns/1-strategy/" class="sidebar-link">设计模式 - 策略模式</a></li><li><a href="/blog_cs/cate/design-patterns/14-be-template/" class="sidebar-link">设计模式 - 模板模式</a></li><li><a href="/blog_cs/cate/design-patterns/2-observer/" aria-current="page" class="active sidebar-link">设计模式 - 观察者模式</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog_cs/cate/design-patterns/2-observer/#引例-设计天气站" class="sidebar-link">引例：设计天气站</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog_cs/cate/design-patterns/2-observer/#模板源文件" class="sidebar-link heading3">模板源文件</a></li><li class="sidebar-sub-header"><a href="/blog_cs/cate/design-patterns/2-observer/#任务分析" class="sidebar-link heading3">任务分析</a></li><li class="sidebar-sub-header"><a href="/blog_cs/cate/design-patterns/2-observer/#错误示例" class="sidebar-link heading3">错误示例</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog_cs/cate/design-patterns/2-observer/#观察者模式" class="sidebar-link">观察者模式</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog_cs/cate/design-patterns/2-observer/#定义" class="sidebar-link heading3">定义</a></li><li class="sidebar-sub-header"><a href="/blog_cs/cate/design-patterns/2-observer/#模型" class="sidebar-link heading3">模型</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog_cs/cate/design-patterns/2-observer/#具体实现" class="sidebar-link">具体实现</a></li><li class="sidebar-sub-header"><a href="/blog_cs/cate/design-patterns/2-observer/#松耦合" class="sidebar-link">松耦合</a></li><li class="sidebar-sub-header"><a href="/blog_cs/cate/design-patterns/2-observer/#气象站的实现" class="sidebar-link">气象站的实现</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog_cs/cate/design-patterns/2-observer/#主题的实现" class="sidebar-link heading3">主题的实现</a></li><li class="sidebar-sub-header"><a href="/blog_cs/cate/design-patterns/2-observer/#观察者的实现" class="sidebar-link heading3">观察者的实现</a></li><li class="sidebar-sub-header"><a href="/blog_cs/cate/design-patterns/2-observer/#简单地测试" class="sidebar-link heading3">简单地测试</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog_cs/cate/design-patterns/2-observer/#vue-中的观察者模式" class="sidebar-link">vue 中的观察者模式</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog_cs/cate/design-patterns/2-observer/#definereactive" class="sidebar-link heading3">defineReactive</a></li><li class="sidebar-sub-header"><a href="/blog_cs/cate/design-patterns/2-observer/#观察者" class="sidebar-link heading3">观察者</a></li><li class="sidebar-sub-header"><a href="/blog_cs/cate/design-patterns/2-observer/#主题" class="sidebar-link heading3">主题</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog_cs/cate/design-patterns/2-observer/#小结" class="sidebar-link">小结</a></li></ul></li><li><a href="/blog_cs/cate/design-patterns/3-factory/" class="sidebar-link">设计模式 - 工厂模式</a></li><li><a href="/blog_cs/cate/design-patterns/4-cm-singleton/" class="sidebar-link">设计模式 - 单例模式</a></li><li><a href="/blog_cs/cate/design-patterns/5-cm-prototype/" class="sidebar-link">设计模式 - 原型模式</a></li><li><a href="/blog_cs/cate/design-patterns/6-cm-builder/" class="sidebar-link">设计模式 - 建造者模式（生成器模式）</a></li><li><a href="/blog_cs/cate/design-patterns/7-st-adapter/" class="sidebar-link">设计模式 - 适配器模式</a></li><li><a href="/blog_cs/cate/design-patterns/9-st-decoration/" class="sidebar-link">设计模式 - 装饰者模式</a></li></ul> </aside> <main class="page"><nav class="breadcrumb"><ol vocab="https://schema.org/" typeof="BreadcrumbList"><li property="itemListElement" typeof="ListItem"><a href="/blog_cs/cate/" property="item" typeof="WebPage" class="router-link-active"><!----> <span property="name">分类</span></a> <meta property="position" content="1"></li><li property="itemListElement" typeof="ListItem"><a href="/blog_cs/cate/design-patterns/" property="item" typeof="WebPage" class="router-link-active"><!----> <span property="name">设计模式</span></a> <meta property="position" content="2"></li><li property="itemListElement" typeof="ListItem" class="is-active"><a href="/blog_cs/cate/design-patterns/2-observer/" aria-current="page" property="item" typeof="WebPage" class="router-link-exact-active router-link-active"><!----> <span property="name">设计模式 - 观察者模式</span></a> <meta property="position" content="3"></li></ol></nav>  <div vocab="https://schema.org/" typeof="Article" class="page-title"><h1><!----> <span property="headline">设计模式 - 观察者模式</span></h1> <div class="page-info"><!----> <span aria-label="Author🖊" data-balloon-pos="down"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon author-icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z" fill="currentColor"></path></svg> <span property="author">ru shui</span></span><!----><span aria-label="Writing Date📅" data-balloon-pos="down" class="time-info"><svg viewBox="0 0 1030 1024" xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 0 1-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 0 1-33.473-33.473V143.657H180.6A134.314 134.314 0 0 0 46.66 277.595v535.756A134.314 134.314 0 0 0 180.6 947.289h669.74a134.36 134.36 0 0 0 133.94-133.938V277.595a134.314 134.314 0 0 0-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 0 1-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 0 1-33.472 33.473z" fill="currentColor"></path></svg> <span property="datePublished">2021-05-14 </span></span><span role="navigation" aria-label="Category🌈" data-balloon-pos="down" class="category-info enable"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon category-icon"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zm-.854 446.486H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zm446.371-446.486h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zm136.293 813.51H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z" fill="currentColor"></path></svg> <span property="articleSection">设计模式</span></span><span aria-label="Tags🏷" data-balloon-pos="down"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon tag-icon"><path d="M939.902 458.563 910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 0 0 0 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z" fill="currentColor"></path></svg> <ul class="tags-wrapper"><li class="tag clickable tag0"><span role="navigation">Typescript</span></li><li class="tag clickable tag1"><span role="navigation">Design pattern</span></li> <meta property="keywords" content="Typescript,Design pattern"></ul></span><span aria-label="Reading Time⌛" data-balloon-pos="down" class="reading-time-info"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon timer-icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z" fill="currentColor"></path></svg> <span>About 12 min</span> <meta property="timeRequired" content="PT12M"></span></div> <!----> <hr></div> <div class="anchor-place-holder"><aside id="anchor"><div class="anchor-wrapper"><ul class="anchor-list"><li class="anchor"><a href="/blog_cs/cate/design-patterns/2-observer/#引例-设计天气站" class="anchor-link heading2"><div>引例：设计天气站</div></a></li><li class="anchor"><a href="/blog_cs/cate/design-patterns/2-observer/#模板源文件" class="anchor-link heading3"><div>模板源文件</div></a></li><li class="anchor"><a href="/blog_cs/cate/design-patterns/2-observer/#任务分析" class="anchor-link heading3"><div>任务分析</div></a></li><li class="anchor"><a href="/blog_cs/cate/design-patterns/2-observer/#错误示例" class="anchor-link heading3"><div>错误示例</div></a></li><li class="anchor"><a href="/blog_cs/cate/design-patterns/2-observer/#观察者模式" class="anchor-link heading2"><div>观察者模式</div></a></li><li class="anchor"><a href="/blog_cs/cate/design-patterns/2-observer/#定义" class="anchor-link heading3"><div>定义</div></a></li><li class="anchor"><a href="/blog_cs/cate/design-patterns/2-observer/#模型" class="anchor-link heading3"><div>模型</div></a></li><li class="anchor"><a href="/blog_cs/cate/design-patterns/2-observer/#具体实现" class="anchor-link heading2"><div>具体实现</div></a></li><li class="anchor"><a href="/blog_cs/cate/design-patterns/2-observer/#松耦合" class="anchor-link heading2"><div>松耦合</div></a></li><li class="anchor"><a href="/blog_cs/cate/design-patterns/2-observer/#气象站的实现" class="anchor-link heading2"><div>气象站的实现</div></a></li><li class="anchor"><a href="/blog_cs/cate/design-patterns/2-observer/#主题的实现" class="anchor-link heading3"><div>主题的实现</div></a></li><li class="anchor"><a href="/blog_cs/cate/design-patterns/2-observer/#观察者的实现" class="anchor-link heading3"><div>观察者的实现</div></a></li><li class="anchor"><a href="/blog_cs/cate/design-patterns/2-observer/#简单地测试" class="anchor-link heading3"><div>简单地测试</div></a></li><li class="anchor"><a href="/blog_cs/cate/design-patterns/2-observer/#vue-中的观察者模式" class="anchor-link heading2"><div>vue 中的观察者模式</div></a></li><li class="anchor"><a href="/blog_cs/cate/design-patterns/2-observer/#definereactive" class="anchor-link heading3"><div>defineReactive</div></a></li><li class="anchor"><a href="/blog_cs/cate/design-patterns/2-observer/#观察者" class="anchor-link heading3"><div>观察者</div></a></li><li class="anchor"><a href="/blog_cs/cate/design-patterns/2-observer/#主题" class="anchor-link heading3"><div>主题</div></a></li><li class="anchor"><a href="/blog_cs/cate/design-patterns/2-observer/#小结" class="anchor-link heading2"><div>小结</div></a></li></ul></div></aside></div> <div class="theme-default-content content__default"><center><img src="/blog_cs/assets/img/design-pattern.39c116b1.jpg"></center>
（本文是基于《Head First 设计模式》观察者模式的学习笔记）
<h2 id="引例-设计天气站"><a href="#引例-设计天气站" class="header-anchor">#</a> 引例：设计天气站</h2> <p>我司最近接到一笔订单，要求我们在 <code>WeatherData</code> 对象上建立一个应用。要求如下：
该应用需要有三种布告板，分别显示当前的状况（<code>currentConditions</code>），气象统计（<code>statistics</code>）以及简单的预报（<code>forecast</code>），而且<strong>必须是实时更新</strong>的。</p> <p>此外，这得是一个<strong>可扩张</strong>的气象站，甲方希望公布一组 API，好让其他开发人员可以写出自己的气象布告板，并插入到此应用中。希望我司能够提供这样的 API。</p> <p><img src="/blog_cs/assets/img/2021-05-14-22-18-21.d56ea98a.png" alt=""></p> <h3 id="模板源文件"><a href="#模板源文件" class="header-anchor">#</a> 模板源文件</h3> <p>甲方在第二天提供了提供了模板源文件：</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">class</span> <span class="token class-name">WeatherData</span> <span class="token punctuation">{</span>
  <span class="token comment">// 获取温度、湿度、压力。我们不需要知道具体的获取步骤</span>
  <span class="token comment">// 只需要直接调用即可。</span>
  <span class="token function">getTemperature</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">getHumidity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">getPressure</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token comment">// 一旦气象测量发生变化，调用此方法。</span>
  <span class="token function">measurementChanged</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>我们的主要任务就是实现 <code>measurementChanged()</code>，好让它更新当前状况，气象统计，天气预报的显示布告板。</p> <h3 id="任务分析"><a href="#任务分析" class="header-anchor">#</a> 任务分析</h3> <ol><li><code>WeatherData</code> 类具有各种 <code>getter</code> 方法，可以得到三个测量值：温度、湿度和压力。</li> <li>当数据发生变化是，<code>measurementChanged()</code> 方法就会被调用。（这与 <code>vue</code> 很像）而且，我们不在乎该方法是如何被调用的，我们只在乎它被调用了。</li> <li>我们需要实现三个使用天气数据的布告板：“当前状况”布告板、“气象统计”布告板、“天气预报”布告板。一旦 <code>WeatherData</code> 数据发生变化，这些布告板立刻更新。</li> <li>该系统必须可以扩张。其他开发人员可以建立定制的布告板，用户可以随心所欲地添加或删除任何布告板。</li></ol> <p><img src="/blog_cs/assets/img/2021-05-14-22-37-06.0341f1ff.png" alt=""></p> <h3 id="错误示例"><a href="#错误示例" class="header-anchor">#</a> 错误示例</h3> <p>在开始动手之前，我们来看一个错误的示范：</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">class</span> <span class="token class-name">WeatherData</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token function">measurementChanged</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> temp <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getTemperature</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> humidity <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getHumidity</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> pressure <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getPressure</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// 更新布告板，后面会实现</span>
    currentConditionsDisplay<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>temp<span class="token punctuation">,</span> humidity<span class="token punctuation">,</span> pressure<span class="token punctuation">)</span>
    statisticsDisplay<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>temp<span class="token punctuation">,</span> humidity<span class="token punctuation">,</span> pressure<span class="token punctuation">)</span>
    forecastDisplay<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>temp<span class="token punctuation">,</span> humidity<span class="token punctuation">,</span> pressure<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>潜在问题：</p> <ol><li>高度耦合。<br>
显然，我们在 <code>measurementChanged()</code> 中使用了 <code>xxxDisplay</code>。针对具体的实现编程，会导致我们以后在增加或删除布告板是，必须修改程序。</li> <li>缺乏封装性。<br>
对于布告板，我们调用了其 <code>update</code> 方法，很明显，我们可以将其统一成一个接口，并且参数为<code>temp, humidity, pressure</code>。</li></ol> <p>为了解决该问题，我们可以使用观察者模式。</p> <h2 id="观察者模式"><a href="#观察者模式" class="header-anchor">#</a> 观察者模式</h2> <p>在讲观察者模式之前，来看生活中的一个例子——报纸和杂志的订阅。</p> <ol><li>我们向某家报社订阅报纸。只要他们有新报纸出版，就会给我们送过来。只要我们还是他们的用户，他们就会不断地给我们送报纸。</li> <li>当我们不想再收到报纸的时候，我们可以取消订阅，报社将不会再送新的报纸过来。</li> <li>只要报社还在运行，就会有新的用户/单位向他们订阅报纸/取消订阅。</li></ol> <p><img src="/blog_cs/assets/img/2021-05-15-00-00-15.99e9922d.png" alt=""></p> <p>从上图中我们可以知道，当用户订阅了出版社的报纸时，每当出版社有新的报纸，就会通知（notifyObservers）订阅的用户。没有订阅的则不会收到出版社的通知。</p> <p>事实上，观察者就是这样一个原理。如果我们把出版社改为“主题”（Subject），订阅者/用户改为“观察者”（Observer）。这就是我们的观察者模式。</p> <p><img src="/blog_cs/assets/img/2021-05-15-00-05-15.0712846d.png" alt=""></p> <p>从上面的图中我们可以知道，一个主题对应多个对象。也就是说观察者模式定义了一对多的关系。</p> <h3 id="定义"><a href="#定义" class="header-anchor">#</a> 定义</h3> <blockquote><p><strong>观察者模式</strong>：定了了对象之间的<strong>一对多</strong>依赖。当一个对象的状态发生改变时，它的所有依赖者都会收到通知并且更新。</p></blockquote> <h3 id="模型"><a href="#模型" class="header-anchor">#</a> 模型</h3> <p>在观察者模式中，主题（Subject）可以添加观察者（addObserver），删除观察者（deleteObserver），通知（发布消息）所有的观察者（notifyObservers）。对于我们的观察者（Observer）对象，应该提供一个更新（update）功能，当主题发生变化时，会根据我们提供的更新功能进行更新。</p> <p>类比到生活中的例子。报社就是主题（Subject），报社的用户就是观察者（Observer）。报社可以添加用户、删除用户和通知用户，对于没用订阅的用户，报社不会给予理睬。对于用户一端，用户可以向报社订阅报纸，也可以取消订阅。</p> <p>下面来看观察者模式的抽象代码：</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">interface</span> <span class="token class-name">Observer</span> <span class="token punctuation">{</span>
  <span class="token function">update</span><span class="token punctuation">(</span><span class="token comment">/*some states*/</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">any</span>
<span class="token punctuation">}</span>

<span class="token keyword">interface</span> <span class="token class-name">Subject</span> <span class="token punctuation">{</span>
  observers<span class="token operator">:</span> Observer<span class="token punctuation">[</span><span class="token punctuation">]</span>

  <span class="token function">addObserver</span><span class="token punctuation">(</span>observer<span class="token operator">:</span> Observer<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span>
  <span class="token function">deleteObserver</span><span class="token punctuation">(</span>observer<span class="token operator">:</span> Observer<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span>

  <span class="token function">notifyObservers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><img src="/blog_cs/assets/img/2021-05-15-08-22-09.911de571.png" alt=""></p> <h2 id="具体实现"><a href="#具体实现" class="header-anchor">#</a> 具体实现</h2> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">class</span> <span class="token class-name">ConcreteSubject</span> <span class="token keyword">implements</span> <span class="token class-name">Subject</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> <span class="token keyword">readonly</span> observers<span class="token operator">:</span> Observer<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">private</span> state<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=</span> <span class="token number">1</span>

  <span class="token function">addObserver</span><span class="token punctuation">(</span>observer<span class="token operator">:</span> Observer<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>observers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>observer<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">deleteObserver</span><span class="token punctuation">(</span>observer<span class="token operator">:</span> Observer<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> index <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>observers<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>observer<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> index<span class="token punctuation">,</span> len <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>observers<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>observers<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>observers<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>observers<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">notifyObservers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>observers<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>observer <span class="token operator">=&gt;</span> observer<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">number</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state
  <span class="token punctuation">}</span>
  <span class="token function">setState</span><span class="token punctuation">(</span>state<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">!==</span> state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> state
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">notifyObservers</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">ConcreteObserver</span> <span class="token keyword">implements</span> <span class="token class-name">Observer</span> <span class="token punctuation">{</span>
  <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> subject<span class="token operator">:</span> Subject<span class="token punctuation">,</span> <span class="token keyword">private</span> name<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    subject<span class="token punctuation">.</span><span class="token function">addObserver</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> update data/state.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">deregister</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>subject<span class="token punctuation">.</span><span class="token function">deleteObserver</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><ol><li>主题实现具体的接口。</li> <li>主题在更新状态（<code>setState</code>）时，通知观察者（<code>notifyObservers</code>）。</li> <li>观察者在创建的时候，订阅主题（调用 <code>subject.addObserver</code>）。</li> <li>观察者实现 <code>update</code> 函数。一旦主题状态发生变化，观察者就可以接收到变化。</li></ol> <p>简单地测试：</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">const</span> subject <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcreteSubject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> observer1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcreteObserver</span><span class="token punctuation">(</span>subject<span class="token punctuation">,</span> <span class="token string">'observer1'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> observer2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcreteObserver</span><span class="token punctuation">(</span>subject<span class="token punctuation">,</span> <span class="token string">'observer2'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> observer3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcreteObserver</span><span class="token punctuation">(</span>subject<span class="token punctuation">,</span> <span class="token string">'observer3'</span><span class="token punctuation">)</span>
subject<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>

<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'----------'</span><span class="token punctuation">)</span>
observer2<span class="token punctuation">.</span><span class="token function">deregister</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
subject<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
<span class="token comment">// observer1 update data/state.</span>
<span class="token comment">// observer2 update data/state.</span>
<span class="token comment">// observer3 update data/state.</span>
<span class="token comment">// ----------</span>
<span class="token comment">// observer1 update data/state.</span>
<span class="token comment">// observer3 update data/state.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>上述例子中，观察者（<code>Observer</code>）并没有获取主题（<code>Subject</code>）的状态。事实上，我们可以在观察者中获取到主题的状态。</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">interface</span> <span class="token class-name">Observer</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>

  <span class="token comment">// 获取主题状态。只需要主题在调用观察者 update 方法时，</span>
  <span class="token comment">// 传入主题的状态即可。</span>
  <span class="token function">update</span><span class="token punctuation">(</span>state<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h2 id="松耦合"><a href="#松耦合" class="header-anchor">#</a> 松耦合</h2> <p><strong>观察者模式提供了一种对象设计，让主题和观察者之间松耦合。</strong></p> <p>主题（Subject）只知道观察者（Observer）实现了某个接口（如上面的 <code>Observer</code> 接口）。主题不需要知道观察者的具体类是什么，做了什么事。</p> <p>由于主题的<strong>唯一</strong>依赖是一个实现了 <code>Observer</code> 的接口对象列表，所以我们可以随时添加观察者（ <code>addObserver</code> ）。</p> <p>此外，我们可以在运行时用新的观察者代替现有的观察者，主题不会受到影响。同样的，我们也可以在任何地方删除某些观察者（deleteObserver）。</p> <p>更重要的是，我们可以独立地复用主题或者观察者。如果在别的地方需要用到主题/观察者，我们可以轻易复用，因为它们两者之间的耦合性很低。</p> <h2 id="气象站的实现"><a href="#气象站的实现" class="header-anchor">#</a> 气象站的实现</h2> <p>我们现在就把之前的气象站任务实现了。这里需要实现一个主题（<code>WeatherData</code>），三个观察者（CurrentConditionsDisplay, StatisticsDisplay, ForecastDisplay）</p> <h3 id="主题的实现"><a href="#主题的实现" class="header-anchor">#</a> 主题的实现</h3> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">class</span> <span class="token class-name">WeatherData</span> <span class="token keyword">implements</span> <span class="token class-name">Subject</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> _temperature<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token keyword">private</span> _humidity<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token keyword">private</span> _pressure<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token keyword">private</span> _observers<span class="token operator">:</span> Observer<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

  <span class="token function">getTemperature</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_temperature
  <span class="token punctuation">}</span>

  <span class="token function">getHumidity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_humidity
  <span class="token punctuation">}</span>

  <span class="token function">getPressure</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_pressure
  <span class="token punctuation">}</span>

  <span class="token comment">// 为了实现接口适配</span>
  <span class="token comment">// ⬇⬇⬇⬇⬇⬇⬇⬇⬇⬇⬇⬇⬇⬇⬇⬇</span>
  <span class="token function">measurementChanged</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">notifyObservers</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">setMeasurements</span><span class="token punctuation">(</span>temperature<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> humidity<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> pressure<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_temperature <span class="token operator">=</span> temperature
    <span class="token keyword">this</span><span class="token punctuation">.</span>_humidity <span class="token operator">=</span> humidity
    <span class="token keyword">this</span><span class="token punctuation">.</span>_pressure <span class="token operator">=</span> pressure
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">measurementChanged</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">addObserver</span><span class="token punctuation">(</span>observer<span class="token operator">:</span> Observer<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_observers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>observer<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">deleteObserver</span><span class="token punctuation">(</span>observer<span class="token operator">:</span> Observer<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> index <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_observers<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>observer<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> index<span class="token punctuation">,</span> len <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_observers<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_observers<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_observers<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_observers<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">notifyObservers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_observers<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>observer <span class="token operator">=&gt;</span>
      observer<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_temperature<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_humidity<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_pressure<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br></div></div><p>这里需要注意的点是，我们实现 <code>measurementChanged</code> 是通过 <code>notifyObservers</code> 进行委托实现的。这样做主要是为了与甲方的要求一致。</p> <h3 id="观察者的实现"><a href="#观察者的实现" class="header-anchor">#</a> 观察者的实现</h3> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">interface</span> <span class="token class-name">DisplayElement</span> <span class="token punctuation">{</span>
  <span class="token function">display</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">CurrentConditionsDisplay</span> <span class="token keyword">implements</span> <span class="token class-name">Observer</span><span class="token punctuation">,</span> DisplayElement <span class="token punctuation">{</span>
  <span class="token keyword">private</span> _temperature<span class="token operator">!</span><span class="token operator">:</span> <span class="token builtin">number</span>
  <span class="token keyword">private</span> _humidity<span class="token operator">!</span><span class="token operator">:</span> <span class="token builtin">number</span>
  <span class="token comment">// private subject: Subject</span>

  <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> subject<span class="token operator">:</span> Subject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    subject<span class="token punctuation">.</span><span class="token function">addObserver</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">display</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      <span class="token keyword">typeof</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_temperature <span class="token operator">!==</span> <span class="token string">'undefined'</span> <span class="token operator">&amp;&amp;</span>
      <span class="token keyword">typeof</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_humidity <span class="token operator">!==</span> <span class="token string">'undefined'</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Current conditions: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_temperature<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">F degrees and </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_humidity<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">% humidity</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">update</span><span class="token punctuation">(</span>temperature<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> humidity<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> pressure<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_temperature <span class="token operator">=</span> temperature
    <span class="token keyword">this</span><span class="token punctuation">.</span>_humidity <span class="token operator">=</span> humidity
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">display</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">StatisticsDisplay</span> <span class="token keyword">implements</span> <span class="token class-name">Observer</span><span class="token punctuation">,</span> DisplayElement <span class="token punctuation">{</span>
  <span class="token keyword">private</span> _temperatures<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token comment">// private subject: Subject</span>

  <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> subject<span class="token operator">:</span> Subject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    subject<span class="token punctuation">.</span><span class="token function">addObserver</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">display</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> min<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token builtin">number</span> <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">let</span> max<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token builtin">number</span> <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">let</span> avg<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token builtin">number</span> <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_temperatures<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      min <span class="token operator">=</span> <span class="token string">'unknown'</span>
      max <span class="token operator">=</span> <span class="token string">'unknown'</span>
      avg <span class="token operator">=</span> <span class="token string">'unknown'</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_temperatures<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> a <span class="token operator">-</span> b<span class="token punctuation">)</span>
    min <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_temperatures<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    max <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_temperatures<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>_temperatures<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span>
    avg <span class="token operator">=</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_temperatures<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span>prev<span class="token punctuation">,</span> cur<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> prev <span class="token operator">+</span> cur<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">/</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_temperatures<span class="token punctuation">.</span>length

    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Avg/Max/Min temperature = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>avg<span class="token punctuation">.</span><span class="token function">toFixed</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>min<span class="token punctuation">.</span><span class="token function">toFixed</span><span class="token punctuation">(</span>
        <span class="token number">2</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>max<span class="token punctuation">.</span><span class="token function">toFixed</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">update</span><span class="token punctuation">(</span>temperature<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> humidity<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> pressure<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_temperatures<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>temperature<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">display</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">ForecastDisplay</span> <span class="token keyword">implements</span> <span class="token class-name">Observer</span><span class="token punctuation">,</span> DisplayElement <span class="token punctuation">{</span>
  <span class="token comment">// private _temperatures!: number</span>
  <span class="token comment">// private _humidity!: number</span>
  <span class="token comment">// private _pressure!: number</span>
  <span class="token comment">// private subject: Subject</span>

  <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> subject<span class="token operator">:</span> Subject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    subject<span class="token punctuation">.</span><span class="token function">addObserver</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">display</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Forecast: Improving weather on the way!'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">update</span><span class="token punctuation">(</span>temperature<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> humidity<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> pressure<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">display</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br></div></div><p>除了实现 <code>Observer</code> 接口外，我们还实现了 <code>DisplayElement</code> 接口，方便展示。</p> <h3 id="简单地测试"><a href="#简单地测试" class="header-anchor">#</a> 简单地测试</h3> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">function</span> <span class="token function">weatherStation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> weatherData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeatherData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> currentConditionsDisplay <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CurrentConditionsDisplay</span><span class="token punctuation">(</span>weatherData<span class="token punctuation">)</span>
  <span class="token keyword">const</span> statisticsDisplay <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StatisticsDisplay</span><span class="token punctuation">(</span>weatherData<span class="token punctuation">)</span>
  <span class="token keyword">const</span> forecastDisplay <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ForecastDisplay</span><span class="token punctuation">(</span>weatherData<span class="token punctuation">)</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'-------------------------------------------'</span><span class="token punctuation">)</span>
  weatherData<span class="token punctuation">.</span><span class="token function">setMeasurements</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">,</span> <span class="token number">65</span><span class="token punctuation">,</span> <span class="token number">30.4</span><span class="token punctuation">)</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'-------------------------------------------'</span><span class="token punctuation">)</span>
  weatherData<span class="token punctuation">.</span><span class="token function">setMeasurements</span><span class="token punctuation">(</span><span class="token number">82</span><span class="token punctuation">,</span> <span class="token number">70</span><span class="token punctuation">,</span> <span class="token number">29.2</span><span class="token punctuation">)</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'-------------------------------------------'</span><span class="token punctuation">)</span>
  weatherData<span class="token punctuation">.</span><span class="token function">setMeasurements</span><span class="token punctuation">(</span><span class="token number">78</span><span class="token punctuation">,</span> <span class="token number">90</span><span class="token punctuation">,</span> <span class="token number">29.2</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token function">weatherStation</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// -------------------------------------------</span>
<span class="token comment">// Current conditions: 80F degrees and 65% humidity</span>
<span class="token comment">// Avg/Max/Min temperature = 80.00/80.00/80.00</span>
<span class="token comment">// Forecast: Improving weather on the way!</span>
<span class="token comment">// -------------------------------------------</span>
<span class="token comment">// Current conditions: 82F degrees and 70% humidity</span>
<span class="token comment">// Avg/Max/Min temperature = 81.00/80.00/82.00</span>
<span class="token comment">// Forecast: Improving weather on the way!</span>
<span class="token comment">// -------------------------------------------</span>
<span class="token comment">// Current conditions: 78F degrees and 90% humidity</span>
<span class="token comment">// Avg/Max/Min temperature = 80.00/78.00/82.00</span>
<span class="token comment">// Forecast: Improving weather on the way!</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>从输出的结果上看：当我们执行 <code>weatherData.setMeasurements</code> 时，我们的布告板就会执行 <code>update</code> 操作，这就是我们想要的结果。</p> <h2 id="vue-中的观察者模式"><a href="#vue-中的观察者模式" class="header-anchor">#</a> vue 中的观察者模式</h2> <p>vue 通过主题去完成依赖收集，通过观察者去实现页面更新。</p> <p>由于主题需要去收集依赖，vue 采用了一个巧妙的设计：利用 js 单线程将依赖（也就是我们的观察者）添加到主题的一个静态属性上。所以我们可以在主题的代码上看到。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">Dep</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> target
  <span class="token comment">// others...</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>其次就是收集依赖的时机。对于每一份数据，vue 需要进行依赖收集。例如：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> data<span class="token operator">:</span> <span class="token punctuation">{</span>
  msg<span class="token operator">:</span> <span class="token string">'hello vue'</span><span class="token punctuation">,</span>
  person<span class="token operator">:</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> ’foo’<span class="token punctuation">,</span>
    age<span class="token operator">:</span> <span class="token number">18</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>

Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">defineReactive</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> key<span class="token punctuation">,</span> data<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">defineReactive</span><span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ⬇⬇⬇⬇⬇⬇⬇⬇⬇⬇⬇⬇⬇⬇⬇⬇⬇⬇⬇⬇</span>
  <span class="token comment">// 设置主题 / 收集依赖</span>
  <span class="token keyword">const</span> dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// value 可能是一个对象</span>
  <span class="token function">observe</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ⬇⬇⬇⬇⬇⬇⬇⬇⬇⬇⬇⬇⬇⬇⬇⬇⬇⬇⬇⬇</span>
      dep<span class="token punctuation">.</span><span class="token function">addSubscriber</span><span class="token punctuation">(</span>Dep<span class="token punctuation">.</span>target<span class="token punctuation">)</span>
      <span class="token keyword">return</span> value
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">set</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// console.log('observer: key = ', key)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">===</span> newValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span>
      <span class="token punctuation">}</span>
      value <span class="token operator">=</span> newValue
      <span class="token comment">// newValue 可能是一个对象</span>
      <span class="token function">observe</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span>
      <span class="token comment">// ⬇⬇⬇⬇⬇⬇⬇⬇⬇⬇⬇⬇⬇⬇⬇⬇⬇⬇⬇⬇</span>
      dep<span class="token punctuation">.</span><span class="token function">notifySubscribers</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><p>遍历 data 中的数据时，每一份就是一个主题（或者说依赖）。添加观察者的时机在于使用到该份数据。所以我们可以在 <code>get()</code> 中看到，<code>dep.addSubscriber()</code>。</p> <p>再者，通知观察者的时机在于数据更新时。所以我们可以在 <code>set()</code> 中看到 <code>dep.notifySubscribers()</code>。</p> <p>以 <code>data.msg</code> 为例。当我们将 <code>data.msg</code> 设置为响应式的时候，为其创建一份主题（<code>const dep = new Dep()</code>）。</p> <p>其次，我们要为 <code>data.msg</code> 主题添加观察者，添加观察者的时机在于我们使用了 <code>data.msg</code> 。而使用 <code>data.msg</code> 会触发其 <code>get</code> 方法。所以我们在 <code>get</code> 方法内部进行依赖收集（<code>dep.addSubscriber(Dep.target)</code>）。</p> <p>但是，这里存在的问题是我们如何确定我们需要添加的观察者（依赖）呢？
事实上，我们需要在使用 <code>data.msg</code> 的 <code>get</code> 方法之前就确定好观察者。
vue 以用 js 单线程的特点，在观察者中使用到依赖时，将自己挂到 <code>Dep.target</code> 上。
然后，当执行 <code>data.msg</code> 的 <code>get</code> 方法时，<code>Dep.target</code> 就是我们要的观察者（依赖）。于是在观察者中才有如下代码：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">Watcher</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>

  <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 在使用依赖之前，将自己挂到 Dep.target 上。</span>
    Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token comment">// ⬇⬇⬇⬇⬇⬇⬇⬇⬇⬇⬇⬇⬇⬇⬇⬇⬇⬇⬇⬇⬇</span>
    <span class="token comment">// 使用到依赖</span>
    <span class="token keyword">const</span> newValue <span class="token operator">=</span> Watcher<span class="token punctuation">.</span><span class="token function">compute</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>expr<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>scope<span class="token punctuation">)</span>

    <span class="token comment">// 收集依赖完成，卸载。</span>
    Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token keyword">return</span> newValue
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>具体的代码如下：</p> <h3 id="definereactive"><a href="#definereactive" class="header-anchor">#</a> defineReactive</h3> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">/**
 * 将对象设置为响应式。
 * @param {Object} data
 * @param {*} key
 * @param {*} value
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">defineReactive</span><span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// value 可能是一个对象</span>
  <span class="token function">observe</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    configurable<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    enumerable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      dep<span class="token punctuation">.</span><span class="token function">addSubscriber</span><span class="token punctuation">(</span>Dep<span class="token punctuation">.</span>target<span class="token punctuation">)</span>
      <span class="token keyword">return</span> value
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">set</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// console.log('observer: key = ', key)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">===</span> newValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span>
      <span class="token punctuation">}</span>
      value <span class="token operator">=</span> newValue
      <span class="token comment">// newValue 可能是一个对象</span>
      <span class="token function">observe</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span>
      dep<span class="token punctuation">.</span><span class="token function">notifySubscribers</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><h3 id="观察者"><a href="#观察者" class="header-anchor">#</a> 观察者</h3> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">let</span> uuid <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Watcher</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * 观察者
   * @param {string} expr expression
   * @param {Object} scope
   * @param {Function | undefined} cb callback
   */</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">expr<span class="token punctuation">,</span> scope<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>expr <span class="token operator">=</span> expr
    <span class="token keyword">this</span><span class="token punctuation">.</span>scope <span class="token operator">=</span> scope
    <span class="token keyword">this</span><span class="token punctuation">.</span>cb <span class="token operator">=</span> cb
    <span class="token keyword">this</span><span class="token punctuation">.</span>uuid <span class="token operator">=</span> uuid<span class="token operator">++</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 根据表达式获取相应的数据。
   */</span>
  <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token keyword">const</span> newValue <span class="token operator">=</span> Watcher<span class="token punctuation">.</span><span class="token function">compute</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>expr<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>scope<span class="token punctuation">)</span>
    Dep<span class="token punctuation">.</span>target <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token keyword">return</span> newValue
  <span class="token punctuation">}</span>

  <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> newValue <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isFunction</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>cb<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cb</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// console.log(newValue)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 计算表达式。
   * @param {string} expr expression
   * @param { Object } scope 作用域。
   * @returns {*}
   */</span>
  <span class="token keyword">static</span> <span class="token function">compute</span><span class="token punctuation">(</span><span class="token parameter">expr<span class="token punctuation">,</span> scope</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> func <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token string">'scope'</span><span class="token punctuation">,</span> <span class="token string">'with(scope){return '</span> <span class="token operator">+</span> expr <span class="token operator">+</span> <span class="token string">'}'</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token function">func</span><span class="token punctuation">(</span>scope<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'watcher: '</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><h3 id="主题"><a href="#主题" class="header-anchor">#</a> 主题</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Dep</span> <span class="token punctuation">{</span>
  <span class="token comment">/** @type{ Watcher } */</span>
  <span class="token keyword">static</span> target

  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/** @type{Map&lt;number, Watcher&gt;} */</span>
    <span class="token comment">// 使用 Map 和 使用 [] 类似。</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>subscribers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 添加观察者。
   * @param { Watcher } subscriber
   */</span>
  <span class="token function">addSubscriber</span><span class="token punctuation">(</span><span class="token parameter">subscriber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>subscriber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>subscribers<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>subscriber<span class="token punctuation">.</span>uuid<span class="token punctuation">,</span> subscriber<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 通知观察者。
   */</span>
  <span class="token function">notifySubscribers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>subscribers<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">watcher</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      watcher<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><h2 id="小结"><a href="#小结" class="header-anchor">#</a> 小结</h2> <ul><li>观察者模式定义了对象之间<strong>一对多</strong>的关系。</li> <li>主题用共同的接口来更新观察者（<code>Observer.update</code>）。</li> <li>观察者和倍观察者之间使用<strong>松耦合（loosecoupling）</strong> 方式结合。被观察者不知道观察者的细节，只知道观察者实现了相应的接口。</li></ul> <p>观察者模式中使用的<strong>设计原则</strong>；</p> <ol><li>变与不变。在观察者模式中，会变化的是主题（<code>Subject</code>）的状态（<code>state</code>），以及观察者的数量（<code>observers</code>）。在这个模式下，我们可以改变依赖于主题状态的对象，而不用修改主题。</li> <li>面向接口，而非面向实现。主题于观察者都使用接口实现，观察者利用主题的接口向主题注册（<code>addObserver</code>），而主题利用观察者接口通知观察者（<code>Observer.update</code>），这样可以让两者正常运转，同时又具有松耦合的特性。</li> <li>多用组合，少用继承。观察者模式利用组合讲许多的观察者组合到主题中（<code>observers</code>），对象之间的关系不是通过继承产生的，而是在运行时利用组合的方式而产生的。</li></ol></div> <footer class="page-meta"><!----> <div class="meta-item update-time"><span class="label">Last update:</span> <span class="info">September 10, 2021 10:16</span></div> <div class="meta-item contributors"><span class="label">Contributors: </span> <span class="info"><span title="email: 15622971239@163.com" class="contributor">
          Laishuxin
        </span> , <span title="email: laishuxin170@gmail.com" class="contributor">
          laishuxin170
        </span> <!----></span></div></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/blog_cs/cate/design-patterns/14-be-template/" class="prev"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon prev-icon"><path d="M906.783 588.79c-.02 8.499-6.882 15.36-15.38 15.37l-443.7-.01 75.704 191.682c2.52 6.42.482 13.763-5.038 17.91-5.52 4.168-13.138 4.147-18.616-.092L123.228 524.175a15.362 15.362 0 0 1-6-12.165c0-4.782 2.222-9.277 6-12.185L499.753 210.35a15.388 15.388 0 0 1 9.38-3.195c3.236 0 6.502 1.034 9.236 3.103 5.52 4.147 7.578 11.49 5.038 17.91L447.683 419.84l443.72-.01c8.498.01 15.36 6.881 15.36 15.36l.02 153.6z" fill="currentColor"></path></svg>
        设计模式 - 模板模式
      </a></span> <span class="next"><a href="/blog_cs/cate/design-patterns/3-factory/">
        设计模式 - 工厂模式
        <svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon next-icon"><path d="M906.772 512c0 4.772-2.211 9.267-5.99 12.175L524.257 813.66a15.37 15.37 0 0 1-18.616.092 15.368 15.368 0 0 1-5.038-17.91l75.714-191.672h-443.73c-8.488 0-15.36-6.881-15.36-15.36v-153.6c0-8.489 6.872-15.36 15.36-15.36h443.73l-75.714-191.682a15.358 15.358 0 0 1 5.048-17.91c5.51-4.158 13.128-4.137 18.606.092l376.525 289.485a15.323 15.323 0 0 1 5.99 12.165z" fill="currentColor"></path></svg></a></span></p></div> <!----> </main> <footer class="footer-wrapper"><!----> <div class="footer"><h2 style="width:100%; min-width: 100%;">Ru Shui</h2></div> <div class="copyright">MIT Licensed | Copyright © 2021-present Ru Shui</div></footer></div><div class="global-ui"><!----><!----><div id="pwa-install"><!----> <div id="install-modal-wrapper" style="display:none;"><div class="background"></div> <div class="install-modal"><div class="header"><button aria-label="Close" class="close-button"><svg width="23" height="22" xmlns="http://www.w3.org/2000/svg" class="icon close-icon"><path fill-rule="evenodd" clip-rule="evenodd" d="M1.12.358a1.224 1.224 0 011.729 0l8.92 8.914L20.686.358a1.224 1.224 0 011.73 1.728L13.497 11l8.92 8.913a1.222 1.222 0 11-1.73 1.729l-8.919-8.913-8.92 8.913a1.224 1.224 0 01-1.729-1.729L10.04 11l-8.92-8.914a1.222 1.222 0 010-1.728z" fill="currentColor"></path></svg></button> <div class="logo"><!----> <div class="title"><h1></h1> <p class="desc">This app can be installed on your PC or mobile device.  This will allow this web app to look and behave like any other installed app.  You will find it in your app lists and be able to pin it to your home screen, start menus or task bars.  This installed web app will also be able to safely interact with other apps and your operating system. </p></div></div></div> <div class="content"><div class="highlight"><!----> <!----></div> <div class="description"><h3>Description</h3> <p></p></div></div> <div class="button-wrapper"><button class="install-button">
        Install <span></span></button> <button class="cancel-button">
        Cancel
      </button></div></div></div></div><div tabindex="-1" role="dialog" aria-hidden="true" class="pswp"><div class="pswp__bg"></div> <div class="pswp__scroll-wrap"><div class="pswp__container"><div class="pswp__item"></div> <div class="pswp__item"></div> <div class="pswp__item"></div></div> <div class="pswp__ui pswp__ui--hidden"><div class="pswp__top-bar"><div class="pswp__counter"></div> <button title="Close (Esc)" class="pswp__button pswp__button--close"></button> <button title="Share" class="pswp__button pswp__button--share"></button> <button title="Toggle fullscreen" class="pswp__button pswp__button--fs"></button> <button title="Zoom in/out" class="pswp__button pswp__button--zoom"></button> <div class="pswp__preloader"><div class="pswp__preloader__icn"><div class="pswp__preloader__cut"><div class="pswp__preloader__donut"></div></div></div></div></div> <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class="pswp__share-tooltip"></div></div> <button title="Previous (arrow left)" class="pswp__button pswp__button--arrow--left"></button> <button title="Next (arrow right)" class="pswp__button pswp__button--arrow--right"></button> <div class="pswp__caption"><div class="pswp__caption__center"></div></div></div></div></div></div></div>
    <script src="/blog_cs/assets/js/app.16bd55a2.js" defer></script><script src="/blog_cs/assets/js/layout-Layout.05aaa927.js" defer></script><script src="/blog_cs/assets/js/vendors~layout-Blog~layout-Layout~layout-NotFound.4b319992.js" defer></script><script src="/blog_cs/assets/js/vendors~layout-Blog~layout-Layout~layout-NotFound~layout-Slide.4e62ce68.js" defer></script><script src="/blog_cs/assets/js/vendors~layout-Blog~layout-Layout.6d1cfc91.js" defer></script><script src="/blog_cs/assets/js/page-设计模式-观察者模式.62b37d84.js" defer></script>
  </body>
</html>
